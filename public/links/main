<style>
  :root {
    --bg-teal: #008080;
    --win-gray: #c0c0c0;
    --win-gray-light: #dfdfdf;
    --win-gray-dark: #808080;
    --win-text: #000000;
    --win-white: #ffffff;
    --win-blue: #000080;
    --border-light: #ffffff;
    --border-dark: #000000;
  }

  * {
    box-sizing: border-box;
    cursor: default;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--bg-teal);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 11px;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* UTILS */
  .bevel-out {
    box-shadow: inset 1px 1px var(--border-light), inset -1px -1px var(--border-dark), inset 2px 2px var(--win-gray-light), inset -2px -2px var(--win-gray-dark);
    background-color: var(--win-gray);
  }

  .bevel-in {
    box-shadow: inset 1px 1px var(--win-gray-dark), inset -1px -1px var(--border-light), inset 2px 2px var(--border-dark), inset -2px -2px var(--win-gray-light);
    background-color: var(--win-white);
  }

  .flex-row {
    display: flex;
    align-items: center;
  }

  /* TASKBAR */
  #taskbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 28px;
    background-color: var(--win-gray);
    border-top: 1px solid var(--win-white);
    padding: 2px;
    display: flex;
    justify-content: space-between;
    z-index: 9999;
  }

  #start-button {
    height: 100%;
    padding: 2px 6px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: bold;
    font-size: 12px;
  }

  #start-button:active {
    box-shadow: inset 1px 1px var(--border-dark), inset -1px -1px var(--border-light);
  }

  #taskbar-tray {
    padding: 2px 8px;
    margin-right: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    width: 70px;
  }

  /* WINDOW TEMPLATE STYLES */
  .window {
    position: absolute;
    width: 400px;
    height: 300px;
    top: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    padding: 2px;
    background-color: var(--win-gray);
  }

  .title-bar {
    height: 18px;
    background-color: var(--win-blue);
    color: var(--win-white);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2px;
    margin-bottom: 2px;
  }

  .title-text {
    font-weight: bold;
    margin-left: 2px;
  }

  .title-controls {
    display: flex;
    gap: 2px;
  }

  .win-btn {
    width: 16px;
    height: 14px;
    font-size: 9px;
    line-height: 12px;
    text-align: center;
    background-color: var(--win-gray);
    border: none;
    padding: 0;
    font-family: monospace;
  }

  .toolbar {
    padding: 2px;
    display: flex;
    gap: 4px;
    margin-bottom: 2px;
  }

  .address-bar {
    flex-grow: 1;
    border: none;
    padding: 2px;
    outline: none;
    font-family: inherit;
    font-size: 11px;
  }

  .window-body {
    flex-grow: 1;
    background-color: var(--win-white);
    border: 1px solid var(--win-gray-dark);
    border-right-color: var(--win-white);
    border-bottom-color: var(--win-white);
    box-shadow: inset 1px 1px var(--border-dark);
    overflow: auto;
  }
</style>

<!-- TASKBAR -->
<div id="taskbar">
  <div id="start-button" class="bevel-out">ü™ü Start</div>
  <div id="taskbar-tray" class="bevel-in">12:00 PM</div>
</div>

<!-- HIDDEN WINDOW TEMPLATE -->
<template id="window-template">
  <div class="window bevel-out">
    <div class="title-bar">
      <span class="title-text">My Computer</span>
      <div class="title-controls">
        <button class="win-btn bevel-out">_</button>
        <button class="win-btn bevel-out">‚ñ°</button>
        <button class="win-btn bevel-out">X</button>
      </div>
    </div>
    
    <div class="toolbar">
      <span>Address</span>
      <input type="text" class="address-bar bevel-in" value="C:\" />
      <button class="win-btn bevel-out" style="width: 20px;">‚Üª</button>
      <button class="win-btn bevel-out" style="width: 30px;">Go</button>
    </div>

    <div class="window-body">
      <!-- Content goes here -->
    </div>
  </div>
</template><script>
  window.desktopStyles = document.createElement('style');
  window.desktopStyles.innerHTML = `
    #desktop-grid {
      position: fixed;
      top: 0; left: 0; bottom: 28px; width: 100vw;
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      align-content: flex-start;
      gap: 12px;
      padding: 10px;
      z-index: 0;
    }
    .d-icon {
      width: 72px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .d-icon-img {
      font-size: 32px;
      margin-bottom: 2px;
      filter: drop-shadow(1px 1px 0px rgba(0,0,0,0.3));
    }
    .d-icon-label {
      font-size: 11px;
      color: var(--win-white);
      text-shadow: 1px 1px 1px #000;
      word-wrap: break-word;
      line-height: 1.1;
      padding: 1px 3px;
    }
    .d-icon:active .d-icon-img {
      opacity: 0.7;
    }
    .d-icon.selected .d-icon-label {
      background-color: var(--win-blue);
      outline: 1px dotted var(--win-gray);
    }
  `;
  document.head.appendChild(window.desktopStyles);

  window.desktopGrid = document.createElement('div');
  window.desktopGrid.id = 'desktop-grid';
  document.body.appendChild(window.desktopGrid);

  window.renderDesktopIcons = function() {
    window.desktopGrid.innerHTML = '';
    
    // Safety check if DB globals exist, otherwise defaults for dummy run
    var dbName = window.DB || 'OS_DB';
    var storeName = window.FILES || 'files';

    var request = indexedDB.open(dbName);
    
    request.onupgradeneeded = function(e) {
      // Ensure store exists if we are first
      var db = e.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        db.createObjectStore(storeName);
      }
    };

    request.onsuccess = function(e) {
      var db = e.target.result;
      if (!db.objectStoreNames.contains(storeName)) return;

      var tx = db.transaction(storeName, 'readonly');
      var store = tx.objectStore(storeName);
      var reqKeys = store.getAllKeys();

      reqKeys.onsuccess = function(e) {
        var keys = e.target.result;
        var files = [];
        var folders = new Set();

        // Process keys for top level
        for (var i = 0; i < keys.length; i++) {
          var k = keys[i];
          if (k.indexOf('/') === -1) {
            files.push(k);
          } else {
            folders.add(k.split('/')[0]);
          }
        }

        // Render Folders
        folders.forEach(function(folderName) {
          var el = document.createElement('div');
          el.className = 'd-icon';
          el.dataset.path = folderName;
          el.dataset.type = 'folder';
          el.innerHTML = `
            <div class="d-icon-img">üìÅ</div>
            <div class="d-icon-label">${folderName}</div>
          `;
          window.desktopGrid.appendChild(el);
        });

        // Render Files
        files.forEach(function(fileName) {
          var el = document.createElement('div');
          el.className = 'd-icon';
          el.dataset.path = fileName;
          el.dataset.type = 'file';
          // Label is everything after last slash (or whole string)
          var label = fileName.split('/').pop(); 
          el.innerHTML = `
            <div class="d-icon-img">üìÑ</div>
            <div class="d-icon-label">${label}</div>
          `;
          window.desktopGrid.appendChild(el);
        });
      };
    };
  };

  window.renderDesktopIcons();
</script><script>
  window.explorerStyles = document.createElement('style');
  window.explorerStyles.innerHTML = `
    .window-body {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-content: flex-start;
      gap: 10px;
      padding: 10px;
    }
    .window-body .d-icon {
      width: 64px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .window-body .d-icon-img {
      font-size: 24px;
    }
    .window-body .d-icon-label {
      font-size: 11px;
      color: var(--win-text);
      text-shadow: none;
      word-wrap: break-word;
      line-height: 1.1;
      margin-top: 2px;
    }
    .window-body .d-icon.selected .d-icon-label {
      background-color: var(--win-blue);
      color: var(--win-white);
      outline: 1px dotted var(--win-gray);
    }
  `;
  document.head.appendChild(window.explorerStyles);

  window.fsDbName = window.DB || 'OS_DB';
  window.fsStoreName = window.FILES || 'files';

  window.renderDirectory = function(container, path) {
    container.innerHTML = 'Loading...';
    
    var request = indexedDB.open(window.fsDbName);
    request.onsuccess = function(e) {
      var db = e.target.result;
      if (!db.objectStoreNames.contains(window.fsStoreName)) {
        container.innerHTML = '';
        return;
      }
      
      var tx = db.transaction(window.fsStoreName, 'readonly');
      var store = tx.objectStore(window.fsStoreName);
      var reqKeys = store.getAllKeys();

      reqKeys.onsuccess = function(evt) {
        var keys = evt.target.result;
        container.innerHTML = '';
        
        var files = [];
        var folders = new Set();
        
        // Normalize path: ensure no trailing slash unless empty
        var searchPath = path ? path + '/' : '';
        
        for (var i = 0; i < keys.length; i++) {
          var k = keys[i];
          
          // If we are looking for root, accept anything not starting with / (if any) or handle generic logic
          // Logic: k must start with searchPath
          if (k.startsWith(searchPath)) {
            var rest = k.substring(searchPath.length);
            // If rest contains /, it's a subfolder
            if (rest.indexOf('/') > -1) {
              folders.add(rest.split('/')[0]);
            } else if (rest.length > 0) {
              // It's a file in this folder
              files.push(rest);
            }
          }
        }

        // Render Folders
        folders.forEach(function(fName) {
          var fullPath = searchPath + fName;
          var el = document.createElement('div');
          el.className = 'd-icon';
          el.dataset.path = fullPath;
          el.dataset.type = 'folder';
          el.innerHTML = `
            <div class="d-icon-img">üìÅ</div>
            <div class="d-icon-label">${fName}</div>
          `;
          container.appendChild(el);
        });

        // Render Files
        files.forEach(function(fName) {
          var fullPath = searchPath + fName;
          var el = document.createElement('div');
          el.className = 'd-icon';
          el.dataset.path = fullPath;
          el.dataset.type = 'file';
          el.innerHTML = `
            <div class="d-icon-img">üìÑ</div>
            <div class="d-icon-label">${fName}</div>
          `;
          container.appendChild(el);
        });
      };
    };
  };

  window.navigateWindow = function(winEl, path) {
    var addrBar = winEl.querySelector('.address-bar');
    var bodyEl = winEl.querySelector('.window-body');
    var titleEl = winEl.querySelector('.title-text');
    
    // Update Address
    if (addrBar) addrBar.value = path;
    
    // Update Title (Just use path or "My Computer" if empty)
    if (titleEl) titleEl.innerText = path || 'My Computer';
    
    // Render Content
    window.renderDirectory(bodyEl, path);
  };

  window.openExplorerWindow = function(path) {
    var tmpl = document.getElementById('window-template');
    var clone = tmpl.content.cloneNode(true);
    var winEl = clone.querySelector('.window');
    
    // Slightly randomize position so they don't stack perfectly
    var offset = document.querySelectorAll('.window').length * 20;
    winEl.style.top = (20 + offset) + 'px';
    winEl.style.left = (20 + offset) + 'px';
    
    document.body.appendChild(winEl);
    
    // Initial Navigate
    window.navigateWindow(winEl, path);

    // Focus Address Bar
    var addr = winEl.querySelector('.address-bar');
    if (addr) setTimeout(() => addr.focus(), 0);
  };

  // Event Delegation for Interactions
  document.addEventListener('click', function(e) {
    // 1. Handle Folder Icon Clicks
    var icon = e.target.closest('.d-icon');
    if (icon && icon.dataset.type === 'folder') {
      var path = icon.dataset.path;
      var win = icon.closest('.window');
      
      if (win) {
        // Inside a window: Navigate that window
        window.navigateWindow(win, path);
      } else {
        // On Desktop: Open new window
        window.openExplorerWindow(path);
      }
      return;
    }

    // 2. Handle Go Button
    if (e.target.innerText === 'Go' && e.target.classList.contains('win-btn')) {
      var win = e.target.closest('.window');
      if (win) {
        var addr = win.querySelector('.address-bar');
        window.navigateWindow(win, addr.value);
      }
    }
  });

  // Handle Enter Key in Address Bar
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.classList.contains('address-bar')) {
      var win = e.target.closest('.window');
      if (win) {
        window.navigateWindow(win, e.target.value);
      }
    }
  });
</script><script>
  window.renderFile = function(winEl, path) {
    var body = winEl.querySelector('.window-body');
    body.innerHTML = '';
    
    var iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.display = 'block';
    
    var dbVal = window.DB || 'OS_DB';
    iframe.src = dbVal + '#' + path;
    
    body.appendChild(iframe);
    
    iframe.onload = function() {
      try {
        var cw = iframe.contentWindow;
        cw.addEventListener('hashchange', function() {
          var newPath = cw.location.hash.substring(1);
          var addr = winEl.querySelector('.address-bar');
          var title = winEl.querySelector('.title-text');
          
          if (addr && addr.value !== newPath) {
             addr.value = newPath;
          }
          if (title) {
            title.innerText = newPath;
          }
        });
      } catch (e) {
        console.warn('Iframe cross-origin');
      }
    };
  };

  window.navigateWindow = function(winEl, path) {
    var addr = winEl.querySelector('.address-bar');
    var title = winEl.querySelector('.title-text');
    var body = winEl.querySelector('.window-body');

    if (addr) addr.value = path;
    if (title) title.innerText = path || 'My Computer';
    
    var dbName = window.fsDbName || 'OS_DB';
    var storeName = window.fsStoreName || 'files';
    
    var request = indexedDB.open(dbName);
    request.onsuccess = function(e) {
      var db = e.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        body.style.padding = '10px';
        window.renderDirectory(body, path);
        return;
      }

      var tx = db.transaction(storeName, 'readonly');
      var store = tx.objectStore(storeName);
      
      var getReq = store.get(path);
      getReq.onsuccess = function(ev) {
        if (ev.target.result !== undefined) {
          body.style.padding = '0'; 
          window.renderFile(winEl, path);
        } else {
          body.style.padding = '10px'; 
          window.renderDirectory(body, path);
        }
      };
      getReq.onerror = function() {
        body.style.padding = '10px';
        window.renderDirectory(body, path);
      };
    };
  };

  document.addEventListener('click', function(e) {
    var icon = e.target.closest('.d-icon');
    if (icon && icon.dataset.type === 'file') {
      var path = icon.dataset.path;
      var win = icon.closest('.window');
      
      if (win) {
        window.navigateWindow(win, path);
      } else {
        window.openExplorerWindow(path);
      }
    }
  });
</script><script>
  /* 
   * WINDOW MANAGEMENT & TASKBAR LOGIC
   * Handles dragging, resizing, closing, maximizing, minimizing, and taskbar buttons.
   */

  // 1. Inject Styles for Window Controls and Taskbar Items
  var winMgmtStyles = document.createElement('style');
  winMgmtStyles.innerHTML = `
    /* Taskbar Button Styles */
    .taskbar-item {
      flex: 0 1 150px;
      margin-right: 2px;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: none;
    }
    .taskbar-item.active {
      box-shadow: inset 1px 1px var(--win-gray-dark), inset -1px -1px var(--border-light), inset 2px 2px var(--border-dark), inset -2px -2px var(--win-gray-light);
      background-color: var(--win-white);
      background-image: radial-gradient(var(--win-gray) 15%, transparent 16%), radial-gradient(var(--win-gray) 15%, transparent 16%);
      background-size: 4px 4px;
      background-position: 0 0, 2px 2px;
      font-weight: bold;
    }

    /* Resize Handle */
    .resize-handle {
      position: absolute;
      bottom: 1px;
      right: 1px;
      width: 12px;
      height: 12px;
      cursor: se-resize;
      background: linear-gradient(135deg, transparent 50%, var(--win-gray-dark) 50%, var(--win-gray-dark) 60%, transparent 60%, transparent 70%, var(--win-gray-dark) 70%, var(--win-gray-dark) 80%, transparent 80%);
      z-index: 10;
    }

    /* Maximized State */
    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: calc(100vh - 28px) !important;
      border: none;
    }
    /* Hide resize handle when maximized */
    .window.maximized .resize-handle {
      display: none;
    }
  `;
  document.head.appendChild(winMgmtStyles);

  // 2. Global State
  window.zIndexCounter = 100;
  window.dragState = null;
  window.resizeState = null;

  // 3. Helper: Focus Window
  window.focusWindow = function(winEl) {
    if (!winEl) return;
    // Bring to top
    winEl.style.zIndex = ++window.zIndexCounter;
    
    // Update active state in taskbar
    var allBtns = document.querySelectorAll('.taskbar-item');
    allBtns.forEach(b => b.classList.remove('active'));
    
    if (winEl.taskbarBtn) {
      winEl.taskbarBtn.classList.add('active');
    }
  };

  // 4. Overwrite openExplorerWindow to include management features
  window.originalOpenExplorerWindow = window.openExplorerWindow; // Keep ref if needed logic from before?
  // Actually, we'll just redefine the function completely based on the previous template logic
  // but adding the hooks for taskbar and resizing.
  
  window.openExplorerWindow = function(path) {
    var tmpl = document.getElementById('window-template');
    var clone = tmpl.content.cloneNode(true);
    var winEl = clone.querySelector('.window');
    
    // Position cascade
    var existingWins = document.querySelectorAll('.window');
    var offset = existingWins.length * 20;
    // Keep inside bounds roughly
    var top = 20 + (offset % 300);
    var left = 20 + (offset % 400);
    winEl.style.top = top + 'px';
    winEl.style.left = left + 'px';
    
    // Add Resize Handle
    var resizer = document.createElement('div');
    resizer.className = 'resize-handle';
    winEl.appendChild(resizer);
    
    // Add to DOM
    document.body.appendChild(winEl);
    
    // Create Taskbar Button
    var tb = document.getElementById('taskbar');
    var tray = document.getElementById('taskbar-tray');
    
    var btn = document.createElement('div');
    btn.className = 'taskbar-item bevel-out';
    btn.innerText = path || 'My Computer';
    btn.winRef = winEl;
    winEl.taskbarBtn = btn;
    
    // Taskbar Button Click
    btn.addEventListener('click', function() {
      if (winEl.style.display === 'none') {
        // Restore
        winEl.style.display = 'flex';
        window.focusWindow(winEl);
      } else {
        // If it's already top focused, minimize it
        if (parseInt(winEl.style.zIndex) === window.zIndexCounter) {
          winEl.style.display = 'none';
          btn.classList.remove('active');
        } else {
          // Just focus
          window.focusWindow(winEl);
        }
      }
    });
    
    tb.insertBefore(btn, tray);

    // Observer to sync Title changes to Taskbar
    var titleEl = winEl.querySelector('.title-text');
    var obs = new MutationObserver(function() {
      btn.innerText = titleEl.innerText;
    });
    obs.observe(titleEl, { childList: true, characterData: true, subtree: true });

    // Initial Navigation & Focus
    window.navigateWindow(winEl, path);
    window.focusWindow(winEl);
  };

  // 5. Global Event Listeners (Delegation)

  // MOUSE DOWN: Drag Init, Resize Init, Focus
  document.addEventListener('mousedown', function(e) {
    var win = e.target.closest('.window');
    if (!win) return;
    
    // Always focus on interaction
    window.focusWindow(win);

    // RESIZE START
    if (e.target.classList.contains('resize-handle')) {
      e.preventDefault();
      window.resizeState = {
        el: win,
        startX: e.clientX,
        startY: e.clientY,
        startW: win.offsetWidth,
        startH: win.offsetHeight
      };
      return;
    }

    // DRAG START
    // Must be on title bar, but not on buttons
    if (e.target.closest('.title-bar') && !e.target.closest('.win-btn')) {
      // If maximized, usually windows don't drag, or they restore. 
      // For simplicity, disable drag if maximized.
      if (win.classList.contains('maximized')) return;

      e.preventDefault();
      window.dragState = {
        el: win,
        startX: e.clientX,
        startY: e.clientY,
        startLeft: win.offsetLeft,
        startTop: win.offsetTop
      };
    }
  });

  // MOUSE MOVE: Dragging & Resizing
  document.addEventListener('mousemove', function(e) {
    // Handling Resize
    if (window.resizeState) {
      e.preventDefault();
      var rs = window.resizeState;
      var dx = e.clientX - rs.startX;
      var dy = e.clientY - rs.startY;
      
      var newW = Math.max(150, rs.startW + dx); // Min width
      var newH = Math.max(100, rs.startH + dy); // Min height
      
      rs.el.style.width = newW + 'px';
      rs.el.style.height = newH + 'px';
      return;
    }

    // Handling Drag
    if (window.dragState) {
      e.preventDefault();
      var ds = window.dragState;
      var dx = e.clientX - ds.startX;
      var dy = e.clientY - ds.startY;
      
      ds.el.style.left = (ds.startLeft + dx) + 'px';
      ds.el.style.top = (ds.startTop + dy) + 'px';
    }
  });

  // MOUSE UP: End Drag/Resize
  document.addEventListener('mouseup', function() {
    window.dragState = null;
    window.resizeState = null;
  });

  // CLICK: Window Controls (Close, Max, Min)
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('.win-btn');
    if (!btn) return;
    
    var win = btn.closest('.window');
    if (!win) return;
    
    var action = btn.innerText;
    
    // CLOSE
    if (action === 'X') {
      if (win.taskbarBtn) win.taskbarBtn.remove();
      win.remove();
    }
    
    // MINIMIZE
    else if (action === '_') {
      win.style.display = 'none';
      if (win.taskbarBtn) win.taskbarBtn.classList.remove('active');
    }
    
    // MAXIMIZE / RESTORE
    else if (action === '‚ñ°') {
      win.classList.toggle('maximized');
    }
  });

</script>